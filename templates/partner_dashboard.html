{% extends 'base.html' %}
{% block content %}
<h3>Assigned Bookings</h3>
<table class="table table-bordered" id="partnerTable">
  <thead><tr><th>ID</th><th>Status</th><th>Action</th></tr></thead>
  <tbody></tbody>
</table>

<script>
$(document).ready(function(){
  loadBookings();

  function loadBookings(){
    $.ajax({
      url: '/bookings/booking_status/',
      headers: { 'Authorization': 'Bearer ' + localStorage.getItem('access') },
      success: function(data){
        const tbody = $('#partnerTable tbody');
        tbody.empty();
        data.forEach(b=>{
          const nextStatus = getNextStatus(b.status);
          const updateBtn = nextStatus ? `<button class="btn btn-sm btn-warning updateBtn" data-id="${b.booking_id}" data-status="${nextStatus}">${nextStatus}</button>` : '';
          const chatBtn = `<button class="btn btn-sm btn-info chatBtn" data-id="${b.booking_id}">Chat</button>`;
          tbody.append(`<tr><td>${b.booking_id}</td><td>${b.status}</td><td>${updateBtn} ${chatBtn}</td></tr>`);
        });
      }
    });
  }

  function getNextStatus(s){
    const flow = ['Start', 'Reached', 'Collected', 'Delivered'];
    const idx = flow.indexOf(s);
    return idx < flow.length - 1 ? flow[idx+1] : null;
  }

  $(document).on('click', '.updateBtn', function(){
    const id = $(this).data('id');
    const status = $(this).data('status');
    $.ajax({
      url: `/bookings/booking_status/`,
      type: 'PATCH',
      data: JSON.stringify({ booking_id: id, status: status }),
      contentType: 'application/json',
      headers: { 'Authorization': 'Bearer ' + localStorage.getItem('access') },
      success: loadBookings
    });
  });

  $(document).on('click', '.chatBtn', function(){
    const id = $(this).data('id');
    window.location.href = `/chat/${id}/`;
  });
});
</script>
{% endblock %}
