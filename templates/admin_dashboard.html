{% extends 'base.html' %}
{% block content %}
<h3>All Bookings</h3>
<table class="table table-bordered" id="adminTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Customer</th>
      <th>Status</th>
      <th>Partner ID</th>
      <th>Partner Name</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
$(document).ready(function(){
  loadBookings();

  function loadBookings(){
    $.ajax({
      url: '/bookings/bookings/',
      headers: { 'Authorization': 'Bearer ' + localStorage.getItem('access') },
      success: function(data){
        const tbody = $('#adminTable tbody');
        tbody.empty();

        data.forEach(b => {
          const partnerId = b.partner_id || '-';
          const partnerName = b.partner_name || '-';
          const btnText = partnerId === '-' ? 'Assign' : 'Reassign';
          const btnClass = partnerId === '-' ? 'success' : 'warning';

          const assignBtn = `
            <button class="btn btn-sm btn-${btnClass} assignBtn" data-id="${b.booking_id}">
              ${btnText}
            </button>`;

          tbody.append(`
            <tr>
              <td>${b.booking_id}</td>
              <td>${b.customer}</td>
              <td>${b.status}</td>
              <td>${partnerId}</td>
              <td>${partnerName}</td>
              <td>${assignBtn}</td>
            </tr>
          `);
        });
      }
    });
  }

  $(document).on('click', '.assignBtn', function(){
    const bookingId = $(this).data('id');
    const partnerId = prompt("Enter Partner ID to assign or reassign:");

    if (!partnerId) return alert("Partner ID is required!");

    $.ajax({
      url: `/bookings/assign_booking/`,
      type: 'POST',
      data: JSON.stringify({ booking_id: bookingId, partner_id: partnerId }),
      contentType: 'application/json',
      headers: { 'Authorization': 'Bearer ' + localStorage.getItem('access') },
      success: function(res){
        alert(res.message);
        loadBookings();
      },
      error: function(xhr){
        alert("Error assigning partner: " + (xhr.responseJSON?.message || xhr.statusText));
      }
    });
  });
});
</script>
{% endblock %}
